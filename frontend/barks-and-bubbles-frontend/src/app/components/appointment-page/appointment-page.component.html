<div class="layout"
     (click)="this.togglePanel($event, true)">
  <mat-card class="message-list">
    <mat-card-title>
      <h2 *ngIf="this.appointment && this.appointment.date"
          [innerHTML]="this.DataService.formatDate(this.appointment.date ,false, false)">TITLE</h2>
      <button mat-icon-button
              color="primary"
              matTooltip="Send Appointment Texts"
              (click)="openPanel()"
              *ngIf="this.appointment"
              [disabled]="this.appointment.messages && this.appointment.messages.sentDate">
        <mat-icon>
          <span class="material-symbols-outlined">
            outgoing_mail
          </span>
        </mat-icon>
      </button>
    </mat-card-title>

    <div class="scroll location-layout"
         *ngIf="this.appointment">
      <div *ngFor="let location of this.appointment.location">
        <div *ngFor="let local of getObjectKeys(location)">
          <div class="location-title">
            <h3><b>{{ local }} ({{getNumOfClients(location)}})</b></h3>
            <hr>
          </div>
          <div *ngFor="let clientArr of getObjectValue(location)"
               class="client-cards-container">
            <mat-card *ngFor="let client of clientArr"
                      class="client-card">
              <mat-icon>pets</mat-icon>{{client.petName}}
              <mat-icon>face</mat-icon>{{client.petParentName}}
            </mat-card>
          </div>
        </div>
      </div>
    </div>
  </mat-card>

  <mat-card class="reply-list">
    <mat-card-title>SMS Replies
      <button mat-icon-button
              color="accent"
              matTooltip="Load Responses"
              [disabled]="!hasMessageSent()"
              (click)="
            loadReplies()"
              [ngClass]="{'rotate-image': this.loadingReplies}">
        <mat-icon>
          <span class="material-symbols-outlined">
            sync
          </span>
        </mat-icon>
      </button>

      <button mat-icon-button
              color="primary"
              [disabled]="!hasMessageSent()"
              matTooltip="Schedule Times"
              (click)="this.togglePanel($event, false)">
        <mat-icon>event_upcoming</mat-icon>
      </button>
    </mat-card-title>

    <mat-card-content>

      <div *ngIf="hasMessageSent()"
           style="margin-top: 1em;">
        <h2 class="error-msg"
            style="width: 100%;"
            *ngIf="this.appointment.replies.length == 0">Please load responses to see who replied</h2>

        <div *ngIf="this.appointment.replies.length != 0"
             class="messages-layout scroll">
          <div *ngFor="let client of this.appointment.messages.sentTo">
            <h2 class="client-name">{{client.petName}}
            </h2>

            <div style="display: grid; grid-template-columns: repeat(2,1fr);">
              <!-- messages sent -->
              <div>
                <ng-container *ngFor="let message of this.appointment.replies">
                  <mat-card *ngIf="this.showCard(message, client) && this.message.direction.includes('outbound')"
                            class="message sent"
                            [ngClass]="{'sent': this.message.status == 'delivered', 'unsent': this.message.status == 'failed'}">
                    <mat-card-content>
                      <p>{{message.body}}</p>
                    </mat-card-content>
                    <mat-card-footer align="end">
                      <sub>{{formatStatus(message.status)}} -
                        {{this.DataService.messageDateFormat(message.dateUpdated)}}</sub>
                    </mat-card-footer>
                  </mat-card>
                </ng-container>
              </div>

              <div>
                <ng-container *ngFor="let message of this.appointment.replies">
                  <mat-card *ngIf="this.showCard(message, client) && this.message.direction.includes('inbound')"
                            class="message received">
                    <mat-card-content>
                      <p>{{message.body}}</p>
                    </mat-card-content>
                    <mat-card-footer align="end">
                      <sub>{{formatStatus(message.status)}} -
                        {{this.DataService.messageDateFormat(message.dateUpdated)}}</sub>
                    </mat-card-footer>
                  </mat-card>
                </ng-container>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div *ngIf="!hasMessageSent()"
           style="margin-top: 1em;">
        <h2 class="error-msg"
            style="width: 100%;">Appointment Messages not sent</h2>
      </div>
    </mat-card-content>

  </mat-card>

  <div class="panel-container scroll"
       [@panelState]="panelState"
       (click)="$event.stopPropagation()">
    <div class="panel scroll"
         *ngIf="isPanelOpen">
      <app-appointment-scheduler [clients]="this.appointment.messages.sentTo"
                                 [replies]="this.appointment.replies"
                                 [appId]="this.appointment.id"></app-appointment-scheduler>
    </div>
  </div>
</div>
